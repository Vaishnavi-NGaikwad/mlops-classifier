# name: CI Pipeline - Build, Test & Push

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# jobs:
#   test-and-build:
#     runs-on: ubuntu-latest

#     steps:
#       # 1. Checkout repository
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # 2. Set up Python
#       - name: Set up Python 3.12
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.12"

#       # 3. Install dependencies
#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install pytest

#       # 4. Run unit tests
#       - name: Run unit tests with pytest
#         run: |
#           pytest tests/test_pipeline.py -v --tb=short

#       # 5. Log in to Docker Hub
#       - name: Log in to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # 6. Build Docker image
#       - name: Build Docker image
#         run: |
#           docker build -t ${{ secrets.DOCKER_USERNAME }}/mlops-classifier:latest .

#       # 7. Push Docker image to Docker Hub
#       - name: Push Docker image to Docker Hub
#         run: |
#           docker push ${{ secrets.DOCKER_USERNAME }}/mlops-classifier:latest


name: CI/CD Pipeline - Build, Test, Push & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ─────────────────────────────────────────────
  # JOB 1: CI - Test & Build
  # ─────────────────────────────────────────────
  test-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run unit tests with pytest
        run: |
          pytest tests/test_pipeline.py -v --tb=short

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/mlops-classifier:latest .

      - name: Push Docker image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/mlops-classifier:latest

  # ─────────────────────────────────────────────
  # JOB 2: CD - Deploy & Smoke Test
  # ─────────────────────────────────────────────
  deploy-and-smoke-test:
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull latest Docker image
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/mlops-classifier:latest

      - name: Deploy with Docker Compose
        run: |
          docker compose up -d
          echo "Service deployed successfully"

      - name: Install smoke test dependencies
        run: |
          pip install pillow numpy

      - name: Run smoke tests
        run: |
          chmod +x smoke_test.sh
          ./smoke_test.sh

      - name: Tear down containers
        if: always()
        run: |
          docker compose down